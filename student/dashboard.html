<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="../assets/styles.css" />
</head>
<body>
  <header>
    <div><b>Student Dashboard</b></div>
    <small id="who" class="muted"></small>
  </header>
  <main>
    <div class="card">
      <h3>Available Exams</h3>
      <div id="list"></div>
      <small id="msg" class="muted"></small>
    </div>
  </main>

  <script src="../assets/config.js"></script>
  <script src="../assets/api.js"></script>
  <script>
    const roll = localStorage.getItem('roll');
    const token = localStorage.getItem('token');
    if (!roll || !token) location.href = '../index.html';
    document.getElementById('who').textContent = `Roll: ${roll}`;

    async function load() {
      const data = await apiGet('exams');
      if (!data.ok) {
        document.getElementById('msg').textContent = data.error || 'Failed';
        return;
      }
      const list = document.getElementById('list');
      list.innerHTML = '';
      data.exams.forEach(ex => {
        const div = document.createElement('div');
        div.className = 'q';
        div.innerHTML = `
          <div><b>${ex.title}</b></div>
          <small class="muted">Duration: ${ex.durationMinutes} minutes | Max attempts: ${ex.maxAttempts}</small>
          <div style="margin-top:10px;">
            <button>Start / Resume</button>
          </div>
        `;
        div.querySelector('button').addEventListener('click', async () => {
          const start = await apiPost('startAttempt', { roll, token, examId: ex.examId });
          if (!start.ok) { alert(start.error || 'Cannot start'); return; }
          localStorage.setItem('attemptId', start.attemptId);
          localStorage.setItem('examId', ex.examId);
          localStorage.setItem('startedAt', start.startedAt);
          localStorage.setItem('durationMinutes', String(start.durationMinutes));
          location.href = 'exam.html';
        });
        list.appendChild(div);
      });
    }
    load();
  </script>
</body>
</html>