<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Exam</title>
  <link rel="stylesheet" href="../assets/styles.css" />
</head>
<body>
  <header class="row" style="justify-content:space-between;">
    <div>
      <div><b>Exam</b></div>
      <small id="who" class="muted"></small>
    </div>
    <div class="timer" id="timer">--:--:--</div>
  </header>

  <main>
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div><b id="examTitle">Loading...</b></div>
          <small class="muted">Autosave enabled. Tab-switch/copy/paste events are logged.</small>
        </div>
        <button id="submitBtn">Submit</button>
      </div>
      <div id="msg" class="muted" style="margin-top:8px;"></div>
    </div>

    <div class="card">
      <h3>Questions</h3>
      <div id="questions"></div>
    </div>
  </main>

  <script src="../assets/config.js"></script>
  <script src="../assets/api.js"></script>
  <script>
    const roll = localStorage.getItem('roll');
    const token = localStorage.getItem('token');
    const attemptId = localStorage.getItem('attemptId');
    const examId = localStorage.getItem('examId');
    const startedAtLS = localStorage.getItem('startedAt');
    const durationMinutesLS = Number(localStorage.getItem('durationMinutes') || '120');

    if (!roll || !token || !attemptId || !examId) location.href = '../index.html';
    document.getElementById('who').textContent = `Roll: ${roll} | Attempt: ${attemptId}`;

    // Anti-cheat counters
    let tabSwitches = 0, copyCount = 0, pasteCount = 0;

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) tabSwitches++;
    });
    document.addEventListener('copy', () => { copyCount++; });
    document.addEventListener('paste', () => { pasteCount++; });

    // State
    let QUESTIONS = [];
    const answers = new Map(); // qId -> answer string
    let startedAt = startedAtLS || new Date().toISOString();
    let durationMinutes = durationMinutesLS || 120;

    function setMsg(text, good=true) {
      const msg = document.getElementById('msg');
      msg.textContent = text;
      msg.className = good ? 'muted' : 'bad';
    }

    function msLeft() {
      const startMs = new Date(startedAt).getTime();
      const endMs = startMs + durationMinutes * 60 * 1000;
      return endMs - Date.now();
    }

    function fmt(ms) {
      const s = Math.max(0, Math.floor(ms/1000));
      const hh = String(Math.floor(s/3600)).padStart(2,'0');
      const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      return `${hh}:${mm}:${ss}`;
    }

    function renderQuestions() {
      const root = document.getElementById('questions');
      root.innerHTML = '';

      QUESTIONS.forEach((q, idx) => {
        const div = document.createElement('div');
        div.className = 'q';
        div.innerHTML = `<div><b>Q${idx+1} (${q.marks} marks)</b></div><div style="margin-top:6px;">${q.prompt}</div>`;

        const saved = answers.get(q.qId) ?? '';

        if (q.type === 'MCQ') {
          const opts = document.createElement('div');
          opts.style.marginTop = '8px';

          (q.options || []).forEach((opt, oi) => {
            const row = document.createElement('div');
            row.innerHTML = `
              <label style="display:block;margin:6px 0;">
                <input type="radio" name="${q.qId}" value="${oi}" />
                ${opt}
              </label>`;
            const input = row.querySelector('input');

            // Prefill
            if (saved !== '' && String(saved) === String(oi)) input.checked = true;

            input.addEventListener('change', (e) => {
              answers.set(q.qId, e.target.value);
            });

            opts.appendChild(row);
          });

          div.appendChild(opts);
        } else {
          const ta = document.createElement('textarea');
          ta.rows = (q.type === 'SHORT') ? 3 : 6;
          ta.placeholder = 'Type your answer...';
          ta.value = saved;
          ta.addEventListener('input', (e) => answers.set(q.qId, e.target.value));
          div.appendChild(ta);
        }

        root.appendChild(div);
      });
    }

    async function autosave(suspiciousEvent='') {
      const payloadAnswers = Array.from(answers.entries()).map(([qId, answer]) => ({ qId, answer }));
      const res = await apiPost('autosave', {
        roll, token, attemptId,
        tabSwitches, copyCount, pasteCount,
        suspiciousEvent,
        answers: payloadAnswers
      });
      setMsg(res.ok ? `Autosaved at ${new Date().toLocaleTimeString()}` : (res.error || 'Autosave failed'), !!res.ok);
      return res;
    }

    async function loadQuestionsAndState() {
      setMsg('Loading questions...', true);

      // 1) Load questions from Sheet
      const qres = await apiGet('questions', { examId });
      if (!qres.ok) { setMsg(qres.error || 'Failed to load questions', false); return; }
      QUESTIONS = (qres.questions || []).map(q => ({
        ...q,
        type: String(q.type || '').toUpperCase()
      }));

      // 2) Load attempt state + saved answers
      const ares = await apiGet('attempt', { attemptId, roll, token });
      if (!ares.ok) { setMsg(ares.error || 'Failed to load attempt state', false); return; }

      // Use backend truth for startedAt (prevents cheating by editing localStorage)
      startedAt = ares.attempt.startedAt || startedAt;
      durationMinutes = durationMinutesLS || 120; // duration from localStorage (from exam config) is OK; can also be fetched from Exams if you want
      localStorage.setItem('startedAt', startedAt);

      (ares.answers || []).forEach(a => {
        answers.set(String(a.qId), String(a.answer || ''));
      });

      document.getElementById('examTitle').textContent = `Exam: ${examId}`;
      renderQuestions();
      setMsg('Loaded. Start answering.', true);
    }

    document.getElementById('submitBtn').addEventListener('click', async () => {
      if (!confirm('Submit attempt now?')) return;
      await autosave('Student clicked submit');
      const payloadAnswers = Array.from(answers.entries()).map(([qId, answer]) => ({ qId, answer }));
      const res = await apiPost('submit', { roll, token, attemptId, answers: payloadAnswers });
      if (!res.ok) { alert(res.error || 'Submit failed'); return; }
      localStorage.setItem('lastMcqScore', String(res.mcqScore));
      localStorage.setItem('lastMcqMax', String(res.mcqMax));
      location.href = 'result.html';
    });

    // Timer loop
    setInterval(async () => {
      const left = msLeft();
      document.getElementById('timer').textContent = fmt(left);
      if (left <= 0) {
        await autosave('Auto-submit: time over');
        const payloadAnswers = Array.from(answers.entries()).map(([qId, answer]) => ({ qId, answer }));
        await apiPost('submit', { roll, token, attemptId, answers: payloadAnswers });
        location.href = 'result.html';
      }
    }, 1000);

    // Autosave loop
    setInterval(() => autosave(''), 20000);

    loadQuestionsAndState();
  </script>
</body>
</html>